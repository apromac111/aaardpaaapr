name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' fDenyTSConnections 0
          Restart-Service TermService
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

      - name: Create RDP User
        run: |
          $pass = "P@ssw0rd!$(Get-Random)"
          net user RDP $pass /add
          net localgroup administrators RDP /add
          echo "CREDS=RDP / $pass" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          iwr https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile ts.msi
          Start-Process msiexec.exe -ArgumentList "/i ts.msi /quiet" -Wait

      - name: Start Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 >> $env:GITHUB_ENV

      - name: Install VirtualBox
        run: |
          iwr https://download.virtualbox.org/virtualbox/7.0.14/VirtualBox-7.0.14-161095-Win.exe -OutFile vbox.exe
          Start-Process vbox.exe -ArgumentList "--silent" -Wait

      - name: Download Kali Linux
        run: |
          iwr https://cdimage.kali.org/kali-2024.4/kali-linux-2024.4-virtualbox-amd64.7z -OutFile kali.7z
          choco install 7zip -y
          7z x kali.7z -okali -y

      - name: Import & Start Kali
        run: |
          $ova = Get-ChildItem kali -Recurse -Filter *.ova | Select -First 1
          & "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" import $ova
          $vm = & "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" list vms | Select -First 1
          $vm = ($vm -split '"')[1]
          VBoxManage modifyvm $vm --memory 4096 --cpus 2 --vram 64
          VBoxManage startvm $vm --type headless

      - name: Show Access Info
        run: |
          echo "======================="
          echo "Tailscale IP:"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "User: RDP"
          echo "Pass: $(echo $env:CREDS)"
          echo "Kali login: kali / kali"
          echo "======================="

      - name: Keep Alive
        run: |
          while ($true) { Start-Sleep 300 }
